# 시스템 파이프라인

## 예약 생성 파이프라인

### 입력
- 사용자 인증 정보 (세션 쿠키)
- 예약 요청 정보
  - 차량 ID
  - 시작 시간 (`startAt`)
  - 종료 시간 (`endAt`)
  - 목적지 (`destination`)
  - 탑승 인원 (`passengerCount`)
  - 긴급 여부 (`isUrgent`)
  - 비고 (`note`)

### 처리 단계

#### 1. 인증 및 권한 확인
- 세션 쿠키를 통한 사용자 인증 확인
- USER 권한 이상 확인

#### 2. 차량 유효성 검사
- 차량 존재 여부 확인
- 차량 상태 확인 (AVAILABLE 여부)
- 차량 점검 중 여부 확인

#### 3. 시간 유효성 검사
- 시작 시간이 종료 시간보다 이전인지 확인
- 시작 시간이 현재 시간보다 이후인지 확인
- 과거 시간 예약 방지

#### 4. 좌석 수 검증
- 요청한 탑승 인원이 차량 좌석 수를 초과하지 않는지 확인

#### 5. 예약 충돌 검사
- 동일 차량의 해당 시간대에 기존 예약이 있는지 확인
- 데이터베이스 쿼리를 통한 충돌 예약 조회
- EXCLUDE 제약으로 최종 차단

#### 6. 충돌 처리
- 충돌 발생 시:
  - 대체 차량 자동 검색
  - 사용 가능한 차량 목록 제안
  - 충돌 정보와 함께 에러 응답

#### 7. 예약 생성
- 예약 정보 저장
- 예약 상태를 RESERVED로 설정
- 연장 횟수 및 한도 초기화

#### 8. 감사 로그 기록
- 예약 생성 액션을 감사 로그에 기록
- 사용자 정보, IP 주소, 시간 등 기록

### 출력
- 예약 생성 성공 시: 예약 정보 (ReservationResponse)
- 충돌 발생 시: 충돌 정보 및 대체 차량 제안 (ConflictDetails)
- 오류 발생 시: 에러 코드 및 메시지 (ErrorResponse)

## 예약 연장 파이프라인

### 입력
- 예약 ID
- 연장 시간 (분 단위, 최대 60분)
- 사용자 인증 정보

### 처리 단계

#### 1. 예약 조회 및 권한 확인
- 예약 존재 여부 확인
- 본인 예약인지 또는 ADMIN 권한인지 확인

#### 2. 연장 한도 확인
- 현재 연장 횟수가 최대 연장 횟수(2회) 미만인지 확인
- 연장 시간이 최대 연장 시간(60분) 이하인지 확인

#### 3. 후속 예약 확인
- 연장된 종료 시간 이후에 다음 예약이 있는지 확인
- 충돌 예약 조회

#### 4. 충돌 처리
- 후속 예약이 있는 경우:
  - 대체 차량 자동 검색
  - 대체 차량 제안 또는 연장 거부

#### 5. 예약 연장
- 종료 시간 업데이트
- 연장 횟수 증가
- 버퍼 시간 포함 종료 시간 자동 계산 (트리거)

#### 6. 감사 로그 기록
- 연장 액션을 감사 로그에 기록

### 출력
- 연장 성공 시: 업데이트된 예약 정보
- 충돌 발생 시: 충돌 정보 및 대체 차량 제안
- 오류 발생 시: 에러 코드 및 메시지

## 자동 연장 파이프라인 (설계)

### 입력
- 반납 예정 시간이 지난 예약 목록

### 처리 단계

#### 1. 반납 지연 예약 조회
- 스케줄러가 반납 예정 시간이 지난 예약 조회
- 상태가 IN_USE인 예약 필터링

#### 2. 자동 연장 처리
- 30분씩 자동 연장
- 연장 횟수 확인 (최대 2회)

#### 3. 다음 예약자 알림
- 다음 예약자에게 반납 지연 알림 발송
- 대체 차량 제안 (충돌 시)

#### 4. 감사 로그 기록
- 자동 연장 액션을 감사 로그에 기록

### 출력
- 연장 성공 시: 업데이트된 예약 정보
- 알림 발송 완료

## 동승 요청 파이프라인

### 입력
- 예약 ID (호스트 예약)
- 요청자 사용자 ID
- 요청 좌석 수
- 요청 사유

### 처리 단계

#### 1. 예약 확인
- 호스트 예약 존재 여부 확인
- 예약 상태 확인 (RESERVED 또는 IN_USE)

#### 2. 좌석 수 확인
- 요청 좌석 수가 차량 좌석 수를 초과하지 않는지 확인
- 기존 동승자 수와 요청 좌석 수의 합이 차량 좌석 수를 초과하지 않는지 확인

#### 3. 동승 요청 생성
- 동승 요청 정보 저장
- 상태를 PENDING으로 설정

#### 4. 호스트에게 알림
- 호스트에게 동승 요청 알림 발송

### 출력
- 동승 요청 생성 성공 시: 동승 요청 정보
- 오류 발생 시: 에러 코드 및 메시지

## 동승 요청 응답 파이프라인

### 입력
- 동승 요청 ID
- 응답 상태 (ACCEPTED 또는 REJECTED)
- 호스트 사용자 인증 정보

### 처리 단계

#### 1. 동승 요청 조회 및 권한 확인
- 동승 요청 존재 여부 확인
- 본인 예약인지 또는 ADMIN 권한인지 확인

#### 2. 좌석 수 재확인
- 승인 시: 현재 동승자 수와 요청 좌석 수의 합이 차량 좌석 수를 초과하지 않는지 확인

#### 3. 동승 요청 상태 업데이트
- 상태를 ACCEPTED 또는 REJECTED로 변경
- 응답 시간 기록

#### 4. 요청자에게 알림
- 요청자에게 응답 결과 알림 발송

### 출력
- 응답 처리 성공 시: 업데이트된 동승 요청 정보
- 오류 발생 시: 에러 코드 및 메시지

## 차량 현황 조회 파이프라인

### 입력
- 사용자 인증 정보
- 조회 조건 (선택적)

### 처리 단계

#### 1. 인증 확인
- 세션 쿠키를 통한 사용자 인증 확인

#### 2. 차량 목록 조회
- 활성화된 차량 목록 조회
- 차량별 현재 예약 정보 조회

#### 3. 상태 집계
- 사용 가능한 차량 수
- 사용 중인 차량 수
- 점검 중인 차량 수

### 출력
- 차량 목록 및 현황 정보
- 각 차량의 현재 예약 정보 (있는 경우)

