# 시스템 아키텍처

## 시스템 구성 요소

법인 차량 예약 시스템은 백엔드와 프론트엔드로 구성된 풀스택 웹 애플리케이션입니다.

### 백엔드 구조

백엔드는 Spring Boot 기반으로 도메인 주도 설계(DDD) 패턴을 적용했습니다.

#### 도메인 모듈
- **auth**: 인증 및 세션 관리
- **reservation**: 예약 관리 (핵심 도메인)
- **vehicle**: 차량 정보 관리
- **user**: 사용자 정보 관리
- **rideshare**: 동승 시스템
- **notification**: 알림 시스템

#### 공통 모듈
- **common/entity**: 공통 엔티티 (BaseEntity)
- **common/exception**: 전역 예외 처리 및 비즈니스 예외 정의

### 프론트엔드 구조

프론트엔드는 Vue 3 Composition API를 사용하여 구성했습니다.

#### 화면 구성
- **views/user/**: 사용자 전용 화면
  - 대시보드, 예약 생성/수정, 내 예약 관리, 동승 관리
- **views/admin/**: 관리자 전용 화면
  - 전체 예약 관리, 차량 관리, 사용자 관리, 통계 대시보드

#### 상태 관리
- **composables/**: Vue Composition API 기반 로직
  - useAuth: 인증 상태 관리
  - useReservations: 예약 데이터 관리
  - useVehicles: 차량 정보 관리

#### API 통신
- **services/api.js**: REST API 통신 로직
- 권한별 엔드포인트 분리 (`/user/*`, `/admin/*`)

## 데이터베이스 구조

### 핵심 테이블

#### reservation (예약)
- 예약 정보 저장 (차량 ID, 사용자 ID, 시간, 상태 등)
- 예약 상태 관리 (RESERVED → IN_USE → COMPLETED)
- 연장 횟수 및 한도 관리

#### vehicle (차량)
- 차량 정보 저장 (이름, 좌석 수, 버퍼 시간 등)
- 차량 상태 관리 (AVAILABLE, IN_USE, MAINTENANCE)

#### app_user (사용자)
- 사용자 정보 저장 (사원번호, 이름, 권한 등)
- 권한 관리 (USER, ADMIN)

#### ride_share_request (동승 요청)
- 동승 요청 정보 저장
- 요청 상태 관리 (PENDING → ACCEPTED/REJECTED)

### 데이터베이스 제약

#### EXCLUDE USING GIST 제약
동일 차량의 시간 범위가 겹치지 않도록 데이터베이스 레벨에서 제약을 설정했습니다. `tstzrange` 타입과 GIST 인덱스를 사용하여 범위 겹침을 방지합니다.

#### 트리거
`end_with_buffer` 필드는 차량의 버퍼 시간을 포함한 종료 시간을 자동으로 계산하는 트리거로 관리됩니다.

## 인증 및 권한 관리

### 세션 기반 인증
- 세션 쿠키(SID)를 통한 인증
- 세션 만료 시간 관리

### 권한 체계
- **USER**: 본인 예약만 조회/수정/취소 가능
- **ADMIN**: 전체 예약 조회/수정/취소 가능, 사용자 관리, 대시보드 접근

### API 접근 제어
- Spring Security를 통한 엔드포인트별 권한 체크
- 권한별 네임스페이스 분리 (`/user/*`, `/admin/*`)

## 예약 충돌 처리 구조

### 충돌 감지
1. 애플리케이션 레벨: 예약 생성/수정 시 충돌 검사
2. 데이터베이스 레벨: EXCLUDE 제약으로 최종 차단

### 충돌 처리 정책
- **선점**: 먼저 예약한 사용자가 우선
- **자동 연장**: 반납 지연 시 자동으로 연장 (최대 2회, 총 60분)
- **관리자 승인**: 관리자가 충돌 상황을 판단하여 처리
- **대체 차량 제안**: 충돌 발생 시 사용 가능한 다른 차량 자동 제안

### 우선순위 규칙
1. 긴급 예약 (`is_urgent = true`)
2. 긴 예약 기간 (긴 시간 예약자가 우선)
3. 직책 순위 (`position_rank`)

## 시스템 통신 구조

### API 통신
- REST API 기반 통신
- OpenAPI 3.0 명세서로 인터페이스 정의
- JSON 형식의 요청/응답

### 프론트엔드-백엔드 통신
- Vue 컴포넌트에서 `services/api.js`를 통해 API 호출
- 권한별 엔드포인트 분리로 명확한 접근 제어

## 확장성 고려사항

### 멀티 테넌트 구조
현재는 단일 조직 기준으로 설계되어 있으나, `organization` 테이블을 활용하여 멀티 테넌트 구조로 확장 가능합니다.

### 실시간 기능
현재는 설계만 되어 있으며, WebSocket 등을 통한 실시간 알림 기능 추가가 가능합니다.

